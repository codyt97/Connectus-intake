<!doctype html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ConnectUS — Sales Reps • Intake</title>

<style>
  /* ===== White + Green theme ===== */
  :root{
    --bg:#ffffff; --ink:#0b1b12; --muted:#5b6b61; --line:#e6efe9; --card:#ffffff;
    --accent:#16a34a; --accent-600:#15803d; --accent-50:#ecfdf5; --danger:#dc2626;
    --warn:#b45309; --ok:#15803d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1240px;margin:24px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 10px}
  h3{margin:0 0 8px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:12px}

  /* hidden measurer used to auto-size inputs so ALL text is visible */
  .input-sizer {
    position:absolute; visibility:hidden; white-space:pre;
    left:-9999px; top:-9999px;
  }

  /* --- MDM cleaner layout --- */
  .mdmGrid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .mdmHalf{grid-column:span 12}
  @media(min-width:900px){.mdmHalf{grid-column:span 6}}
  .mdmFull{grid-column:1/-1}

  /* pill-style checkbox row */
  .chk-pill{
    display:flex;align-items:center;gap:10px;justify-content:space-between;
    padding:12px 16px;border:1px solid var(--line);background:#fff;
    border-radius:999px;font-size:14px
  }
  .chk-pill input{transform:scale(1.05);accent-color:var(--accent)}
  /* inline label above inputs keeps existing input styling */
  .field label{margin-bottom:6px}



  /* ===== Main Tabs ===== */
  .maintabs{position:sticky; top:0; z-index:50; display:flex; gap:10px; align-items:center;
    padding:10px 16px; margin:-10px -16px 14px; background:#fffffff2;
    backdrop-filter:saturate(1.1) blur(6px); border-bottom:1px solid var(--line);}
  .mtab{padding:10px 14px; border:1px solid var(--line); border-radius:999px;
    background:#fff; color:var(--ink); cursor:pointer; font-weight:600;}
  .mtab.active{ background:var(--accent); color:#fff; border-color:var(--accent); }
  [data-mainpanel]{ display:none; }
  [data-mainpanel].active{ display:block; }

  /* Header bar + stepper */
  .appbar{position:sticky;top:54px;z-index:40;display:flex;align-items:center;justify-content:space-between;
    padding:10px 16px;margin:-10px -16px 12px;background:#fffffff2; backdrop-filter:saturate(1.1) blur(6px);
    border-bottom:1px solid var(--line);}
  .brandmark{display:flex;gap:10px;align-items:center}
  .brandmark .logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 210deg,#22c55e,#86efac);border:1px solid #bbf7d0}
  .brandmark .t{font-weight:700;letter-spacing:.2px}
  .stepper{display:flex;gap:8px;flex-wrap:wrap}
  .step{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
    background:#fff;color:#0b1b12;cursor:pointer;}
  .step .dot{width:8px;height:8px;border-radius:50%;background:#9ca3af}
  .step.active{background:var(--accent); border-color:var(--accent); color:#fff}
  .step.active .dot{background:#fff}

  /* Chips / tabs / buttons */
  .bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  .chip{border:1px solid var(--line); background:#fff; color:var(--ink);
    padding:7px 10px;border-radius:999px;font-size:12px;display:flex;align-items:center;gap:8px}
  .chip input{accent-color:var(--accent);transform:scale(1.05)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--ink);cursor:pointer;font-size:13px}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}
  button{border:1px solid var(--accent); background:var(--accent); color:#fff;border-radius:10px; padding:10px 14px; font-size:14px; cursor:pointer}
  button:hover{background:var(--accent-600); border-color:var(--accent-600)}
  .ghost{background:#fff;color:var(--accent);border-color:var(--accent)}
  .ghost:hover{background:var(--accent-50)}
  .ok{background:var(--ok); border-color:var(--ok); color:#fff}
  .warn{background:#fff;border-color:var(--warn); color:var(--warn)}
  .bad{background:#fff;border-color:var(--danger); color:#dc2626}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--ink)}
  .tiny{font-size:11px;color:var(--muted)}
  .divider{height:1px;background:var(--line);margin:8px 0 14px}

  /* Cards & inputs */
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 1px 0 #edf2f7;}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .two{grid-column:span 12}@media(min-width:780px){.two{grid-column:span 6}}
  .three{grid-column:span 12}@media(min-width:980px){.three{grid-column:span 4}}
  .full{grid-column:1 / -1}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%; background:#fff; border:1px solid #d9e6de; color:var(--ink); border-radius:10px; padding:10px 12px; font-size:14px; outline:none}
  input:focus,select:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px #22c55e22;}
  .row{display:flex;gap:10px}.row>*{flex:1}

  /* Items table */
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{font-size:12px;color:var(--muted);text-align:left;padding:6px 8px}
  .table td{background:#fff;border:1px solid var(--line);border-left:none;border-right:none;padding:8px;font-size:13px;vertical-align:top}
  .table tr td:first-child{border-radius:10px 0 0 10px;border-left:1px solid var(--line)}
  .table tr td:last-child{border-radius:0 10px 10px 0;border-right:1px solid var(--line)}

  /* Subtabs */
  .subtabs{display:flex;gap:6px;margin:10px 0;flex-wrap:wrap}
  .subtab{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:6px 12px;background:#fff;color:var(--ink);cursor:pointer}
  .subtab.active{background:var(--accent);border-color:var(--accent);color:#fff}

  /* Drawers */
  .drawer{position:fixed;top:0;right:0;height:100%;width:min(560px,96vw);transform:translateX(100%);transition:transform .25s ease;z-index:60;background:#fff;border-left:1px solid var(--line);box-shadow:-8px 0 20px rgba(0,0,0,.06)}
  .drawer.active{transform:translateX(0)}
  .drawer header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line);background:#fff}
  .drawer .content{padding:14px;overflow:auto;height:calc(100% - 54px)}

  /* Summary */
  .summary-box{white-space:pre-wrap;background:#fff;border:1px dashed var(--line);border-radius:12px;padding:12px;
    font-family:ui-monospace,Consolas,monospace;font-size:13px;color:var(--ink)}

  .emailPreview .muted, .muted{color:var(--muted);font-size:12px}
  .totals{margin-top:12px;border:1px solid var(--line);border-radius:14px;background:#fff;padding:12px}
  .totals h4{margin:0 0 8px;font-size:14px;letter-spacing:.2px}
  .totals .rowline{display:flex;justify-content:space-between;margin:4px 0}
</style>
</head>
<body>
<div class="wrap">

  <!-- ===== MAIN TABS ===== -->
  <nav class="maintabs" id="maintabs">
    <button class="mtab active" data-main="reps">Sales Reps</button>
    <button class="mtab" data-main="intake">Quote / Sales Order Intake</button>
  </nav>

  <!-- ========== PANEL: SALES REPS ========== -->
  <section data-mainpanel="reps" class="active">
    <h1>Sales Rep Management</h1>
    <div class="sub">Maintain the sales rep roster + email templates used by the New Customer flow.</div>

    <section class="card">
      <div class="grid">
        <section class="three">
          <h3>Add / Update Rep</h3>
          <label>Rep Name</label><input id="repNameInput" placeholder="e.g., Lucas Currin" />
          <label style="margin-top:10px">Email</label><input id="repEmailInput" type="email" placeholder="e.g., lucas.currin@connectuscorp.com" />
          <label style="margin-top:10px">Portal Slug (salep-rep)</label><input id="repSlugInput" placeholder="e.g., lucas-currin" />
          <label style="margin-top:10px">Template</label>
          <select id="repTemplatePick">
            <option value="custom">Custom (use editor below)</option>
            <option>Lucas Currin</option>
            <option>Anthony Liace</option>
            <option>John Tropeano</option>
            <option>Greg Flannigan</option>
            <option>Heath Pospisil</option>
            <option>Orlando</option>
          </select>
          <label style="margin-top:10px">Template Editor</label>
          <textarea id="repTemplateText" rows="12" placeholder="Template text with {{ Customer First Name }} and {{Current Email}} placeholders"></textarea>
          <div class="row" style="margin-top:10px">
            <button class="ok" id="btnSaveRep">Save / Update Rep</button>
            <button class="ghost" id="btnResetRepForm">Reset</button>
          </div>
        </section>

        <section class="full">
          <h3>Current Reps</h3>
          <div class="tiny">These populate the Primary/Secondary Rep dropdowns in the Intake tab and power the New Customer invite.</div>
          <div id="repList" style="margin-top:8px"></div>
        </section>
      </div>
    </section>
  </section>

  <!-- ========== PANEL: INTAKE ========== -->
  <section data-mainpanel="intake">
    <div class="appbar">
      <div class="brandmark">
        <div class="logo"></div><div class="t">ConnectUS — Quote / Sales Order</div>
      </div>
      <div class="stepper" id="stepper" style="display:none">
        <div class="step active" data-goto="customer"><div class="dot"></div>Customer</div>
        <div class="step" data-goto="shipping"><div class="dot"></div>Shipping</div>
        <div class="step" data-goto="items"><div class="dot"></div>Items</div>
        <div class="step" data-goto="mdm"><div class="dot"></div>MDM</div>
      </div>
    </div>

    <h1>Quote / Sales Order Intake</h1>
    <div class="sub">Start by choosing **New Order** or **Clone existing order**. Once selected, the tabs will unlock.</div>

    <!-- ===== Order Mode Gate ===== -->
    <section class="card" id="orderModeCard">
      <h3>Order Mode</h3>
      <div class="bar" role="group" aria-label="Order mode selection">
        <label class="chip"><input type="radio" name="order_mode" value="new"> New Order</label>
        <label class="chip"><input type="radio" name="order_mode" value="clone"> Clone existing order</label>
      </div>

      <!-- New-format follow-up -->
      <div id="orderTypeRow" style="display:none">
        <label>New Order Type</label>
        <div class="bar" role="group" aria-label="New order type">
          <label class="chip"><input type="radio" name="order_type" value="hardware"> Hardware only</label>
          <label class="chip"><input type="radio" name="order_type" value="pro"> Hardware + Pro Services</label>
        </div>
        <div class="tiny">Picking an option will unlock the Customer/Shipping/Items/MDM tabs.</div>
      </div>

      <!-- Clone verification checklist -->
      <div id="cloneVerifyRow" style="display:none; margin-top:10px">
  <label>Verification Checklist</label>

  <!-- Sales Order Number -->
  <div class="grid" style="align-items:start; margin-bottom:8px">
    <div class="mdmHalf">
      <label>Existing Sales Order #</label>
      <input id="soClone" placeholder="e.g., SO-2025-00421" />
      <div class="tiny">Required for clone submissions.</div>
    </div>
    <div class="mdmHalf"></div>
  </div>

  <div class="grid" style="align-items:start">
    <!-- Customer -->
    <div class="mdmHalf">
      <label class="chk-pill">
        <span>I have verified Customer information</span>
        <input type="checkbox" id="vCustomer">
      </label>
    </div>
    <div class="mdmHalf">
      <label>Customer Notes</label>
      <textarea id="vCustomerNote" rows="2" placeholder="What did you check / confirm?"></textarea>
    </div>

    <!-- Shipping -->
    <div class="mdmHalf">
      <label class="chk-pill">
        <span>I have verified Shipping information</span>
        <input type="checkbox" id="vShipping">
      </label>
    </div>
    <div class="mdmHalf">
      <label>Shipping Notes</label>
      <textarea id="vShippingNote" rows="2" placeholder="Addresses, dates, method, etc."></textarea>
    </div>

    <!-- Items -->
    <div class="mdmHalf">
      <label class="chk-pill">
        <span>I have verified Items</span>
        <input type="checkbox" id="vItems">
      </label>
    </div>
    <div class="mdmHalf">
      <label>Items Notes</label>
      <textarea id="vItemsNote" rows="2" placeholder="Models, qty, pricing assumptions, substitutions…"></textarea>
    </div>

    <!-- MDM -->
    <div class="mdmHalf">
      <label class="chk-pill">
        <span>I have verified MDM</span>
        <input type="checkbox" id="vMDM">
      </label>
    </div>
    <div class="mdmHalf">
      <label>MDM Notes</label>
      <textarea id="vMDMNote" rows="2" placeholder="Enrollment, ABM/Knox/ZTE, plan codes, etc."></textarea>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button id="btnProceedClone" class="ok" disabled>Proceed (record & email OM)</button>
  </div>
</div>

    </section>

    <!-- toggles (kept) -->
    <div class="bar">
      <label class="chip"><input type="checkbox" id="flagNewCustomer"> NEW Customer</label>
      <label class="chip"><input type="checkbox" id="flagWCP"> WCP</label>
      <label class="chip"><input type="checkbox" id="flagCurrentCustomer"> Current Customer</label>
      <label class="chip"><input type="checkbox" id="flag3PL"> 3PL Restock Order</label>
      <label class="chip"><input type="radio" name="doctype" value="QUOTE" checked> QUOTE</label>
      <label class="chip"><input type="radio" name="doctype" value="SALES ORDER"> SALES ORDER</label>
      <button class="ghost" id="btnDemoFlow" title="Runs a full current-customer example">Demo: Current Customer Flow</button>
    </div>

    <!-- Intake Tabs (hidden until unlocked) -->
    <div id="intakeTabsWrap" style="display:none">
      <div class="tabs">
        <button class="tab active" data-tab="customer">Customer</button>
        <button class="tab" data-tab="shipping">Shipping</button>
        <button class="tab" data-tab="items">Items</button>
        <button class="tab" data-tab="mdm">MDM</button>
      </div>

      <div class="sub">Tabs: <span class="pill">Customer</span> · <span class="pill">Shipping</span> · <span class="pill">Items</span> · <span class="pill">MDM</span></div>

      <!-- CUSTOMER -->
      <section class="card" data-panel="customer">
        <div class="grid">
          <section class="three">
            <h3>Sales & Partner</h3>
            <label>Primary Sales Rep</label>
            <select id="rep1"></select>
            <label style="margin-top:10px">Secondary Sales Rep</label>
            <select id="rep2"></select>
            <div class="divider"></div>
            <label>Referral Partner</label>
            <select id="refPartner"><option>None</option><option>AT&T</option><option>Verizon</option><option>T-Mobile</option><option>Other</option></select>
          </section>

          <section class="three">
            <h3>Carrier / Activation</h3>
            <label>Carrier Rep Name</label><input id="carrierRepName" placeholder="First Last" />
            <label style="margin-top:10px">Carrier Rep Email</label><input id="carrierRepEmail" type="email" placeholder="rep@carrier.com" />
            <label style="margin-top:10px">Internal Activation CUC Rep</label><input id="cucRep" placeholder="Name / Team" />
          </section>

          <section class="two">
            <h3>Billing Info</h3>
            <label style="margin-top:10px">Customer PO</label>
            <input id="customerPO" placeholder="PO-12345 (optional)" />
            <label>Company Name</label><input id="billCompany" />
            <div class="row"><div><label>Contact Name</label><input id="billContact" /></div><div><label>Contact Phone</label><input id="billPhone" /></div></div>
            <label>Email</label><input id="billEmail" type="email" />
            <div class="row"><div><label>Street Address</label><input id="billStreet" /></div><div><label>Floor / Suite</label><input id="billSuite" /></div></div>
            <div class="row"><div><label>City</label><input id="billCity" /></div><div><label>State</label><input id="billState" /></div><div><label>Zip Code</label><input id="billZip" /></div></div>
          </section>

          <section class="two">
            <h3>Payment & Tax</h3>
            <label>Payment Method</label>
            <select id="payMethod"><option value="">Select Payment Method</option><option>ACH</option><option>Wire</option><option>Credit Card</option><option>Net Terms</option></select>
            <label style="margin-top:10px">Payment Terms Procedure</label><input id="payTerms" placeholder="e.g., Net 30, upfront %" />
            <label class="chip" style="margin-top:10px"><input type="checkbox" id="hasAgreement"> Purchase Agreement (no POs)</label>
            <label class="chip" style="margin-top:6px"><input type="checkbox" id="taxExempt"> Tax Exempt? (attach certificate)</label>
          </section>
        </div>
      </section>

      <!-- SHIPPING -->
      <section class="card" data-panel="shipping" style="display:none">
        <div class="grid">
          <section class="two">
            <h3>Shipping Info <label class="chip" style="margin-left:6px"><input type="checkbox" id="resShip"> Residence</label></h3>
            <label>Company Name / Care Of</label><input id="shipCompany" />
            <div class="row"><div><label>Contact Name</label><input id="shipContact" /></div><div><label>Contact Phone</label><input id="shipPhone" /></div></div>
            <label>Email</label><input id="shipEmail" type="email" />
            <div class="row"><div><label>Street Address</label><input id="shipStreet" /></div><div><label>Floor / Suite</label><input id="shipSuite" /></div></div>
            <div class="row"><div><label>City</label><input id="shipCity" /></div><div><label>State</label><input id="shipState" /></div><div><label>Zip Code</label><input id="shipZip" /></div></div>
            <div class="row"><div><label>Customer Requested Ship Date</label><input id="reqShipDate" type="date" /></div><div><label>Expected Ship Date (Ops/Purchasing)</label><input id="expShipDate" type="date" /></div></div>
          </section>

          <section class="three">
            <h3>Shipping Options</h3>
            <label>Shipping Payment Method</label>
            <select id="shipPay">
              <option value="">Select Shipping Pmt Method</option>
              <option>CUC UPS and Invoice customer</option>
              <option>Customer UPS / FedEx account</option>
              <option>Customer provided shipping label</option>
              <option>Pick up at warehouse</option>
              <option>USPS and Invoice customer</option>
            </select>
            <label style="margin-top:10px">Shipping Speed</label>
            <select id="shipSpeed"><option value="">Select Shipping Speed</option><option>Ground</option><option>2-Day</option><option>Overnight</option></select>
            <label style="margin-top:10px">Short Ship?</label>
            <select id="shortShip"><option value="">Select</option><option>No</option><option>Yes (Backorder OK)</option></select>
          </section>

          <section class="full">
            <h3>Internal Notes</h3>
            <textarea id="notes" rows="4" placeholder="Any Tech Zone scope, PS details, or routing notes"></textarea>
          </section>
        </div>
      </section>

      <!-- ITEMS -->
      <section class="card" data-panel="items" style="display:none">
        <h3>Items</h3>
        <div class="grid">
          <section class="three">
            <label>Quote Request ID (Sales → Purchasing)</label>
            <div class="row"><input id="qrid" placeholder="e.g., QR-2025-00123" /><button class="ghost" id="btnLoadQR">Load by ID</button></div>
            <div class="tiny">Enter a QR ID to prefill the line. Subtabs appear for Accessory, Services, Insurance, SIM/Pairing, and Licenses.</div>
          </section>
          <section class="full" id="itemsCard">
            <div class="row" style="gap:10px;margin-bottom:6px"><button onclick="addRow()">+ Add Line</button><button class="ghost" onclick="autoExample()">Load Example</button></div>
            <div class="table-wrap" style="overflow:auto;margin-top:8px">
              <table class="table" id="itemsTbl"><thead><tr>
                <th>Description (Mfg / Model / Size / Color)</th>
                <th>Model / Part #</th>
                <th>Color</th>
                <th>OrderTime SKU</th>
                <th>Qty</th>
                <th>LTE / Wi-Fi / Both</th>
                <th>Carrier</th>
                <th>Act Payout $</th>
                <th>MSRP</th>
                <th>Disc %</th>
                <th>Sell Price</th>
                <th>New / CPO</th>
                <th>In Stock?</th>
                <th>Vendor</th>
                <th>Quoted Cost</th>
                <th>SPA Price / Deal Reg #</th>
                <th>Hold/Reservation #</th>
                <th>Line Instructions</th>
                <th>Delivery Lead Time</th>
                <th>EOL Confirm</th>
                <th>Remove</th>
              </tr></thead><tbody id="itemsBody"></tbody></table>
            </div>

            <!-- Subtabs -->
            <div id="subtabsArea" class="subtabs" style="display:none">
              <button class="subtab active" data-sub="accessory">Accessory</button>
              <button class="subtab" data-sub="services">Services</button>
              <button class="subtab" data-sub="insurance">Insurance</button>
              <button class="subtab" data-sub="sim">SIM / Pairing</button>
              <button class="subtab" data-sub="licenses">Licenses</button>
            </div>

            <!-- Panels -->
            <div id="subtabPanels" style="margin-top:8px;display:none">
              <!-- Accessory -->
              <div data-subpanel="accessory">
                <div class="grid">
                  <section class="three">
                    <label>Accessory SKU</label><input id="accSku" />
                    <label style="margin-top:8px">Accessory Description</label><input id="accDesc" />
                    <label class="chip" style="margin-top:10px"><input type="checkbox" id="bcInclude"> Include Brick + Cable kit</label>
                  </section>
                  <section class="three">
                    <label>Accessory Qty (per unit)</label><input id="accQty" type="number" min="0" value="0" />
                    <label style="margin-top:8px">Accessory Sell Price</label><input id="accSell" type="number" step="0.01" />
                  </section>
                </div>
              </div>

              <!-- Services -->
              <div data-subpanel="services" style="display:none">
                <div class="grid">
                  <section class="three">
                    <h4 style="margin:0 0 8px">Pro Services (per device)</h4>
                    <label class="chip"><input type="checkbox" id="svcEnabled"> Include Services for this item</label>
                    <label style="margin-top:10px">Tier</label>
                    <select id="svcTier">
                      <option value="0">Tier 0 (under ~5 min)</option>
                      <option value="1">Tier 1 (≤ 15 min)</option>
                      <option value="2">Tier 2 (≤ 30 min)</option>
                      <option value="3">Tier 3 (≤ 45 min)</option>
                      <option value="4">Tier 4 (≤ 60 min)</option>
                    </select>
                    <label style="margin-top:10px">SKU</label>
                    <input id="svcSKU" readonly />
                  </section>
                  <section class="three">
                    <label>Minutes (per device)</label>
                    <input id="svcMinutes" type="number" min="1" value="5" />
                    <label style="margin-top:10px">Cost per device ($0.80/min)</label>
                    <input id="svcCostPer" type="number" step="0.01" readonly />
                    <label style="margin-top:10px">Total Services Cost</label>
                    <input id="svcCostTotal" type="number" step="0.01" readonly />
                  </section>
                </div>
                <div class="tiny">Tier 0 defaults to 5 minutes. Tiers 1–4 auto-set minutes = tier × 15.</div>
              </div>

              <!-- Insurance -->
              <div data-subpanel="insurance" style="display:none">
                <div class="grid">
                  <section class="three">
                    <label>Include Insurance?</label>
                    <select id="insEnabled">
                      <option value="">Select</option>
                      <option>Yes</option>
                      <option>No</option>
                    </select>
                  </section>

                  <!-- Hidden until Yes -->
                  <section class="three" id="insFields" style="display:none">
                    <label style="margin-top:8px">Insurance Plan</label>
                    <select id="insPlan"><option>AKKO</option><option>Other</option></select>

                    <label style="margin-top:8px">Deductible</label>
                    <select id="insDed"><option>$0</option><option>$29</option><option>$49</option><option>$99</option><option>$100</option></select>

                    <label style="margin-top:8px">Coverage Length</label>
                    <select id="insTerm"><option>1 year</option><option>2 years</option><option>3 years</option><option>4 years</option></select>

                    <label style="margin-top:8px">Insurance Sell Price</label>
                    <input id="insSell" type="number" step="0.01" />

                    <label style="margin-top:8px">Insurance Cost Price (internal)</label>
                    <input id="insCost" type="number" step="0.01" />
                  </section>
                </div>
              </div>

              <!-- SIM / Pairing -->
              <div data-subpanel="sim" style="display:none">
                <div class="grid">
                  <section class="three">
                    <label>SIM Card</label>
                    <select id="simCard">
                      <option value="">Select SIM card</option>
                      <option>VZ-SIM3IN1</option>
                      <option>AT-SIM3IN1</option>
                      <option>AT-FIRSTSIMA00</option>
                      <option>TM-SIM3IN14G</option>
                      <option>HE-HELIXTRIAA00</option>
                      <option>Helix eSIM (TriA)</option>
                      <option>HE TRI-B Static IP HELIX</option>
                      <option>MW-SIMVZTMATT-E</option>
                      <option>US-SIM3IN15G</option>
                      <option>eSIM embedded in device</option>
                      <option>NO SIM CARD</option>
                    </select>

                    <label style="margin-top:8px">Pairing Option</label>
                    <select id="pairingOption">
                      <option value="">Select Pairing option</option>
                      <option>SIM PAIRING only (self-activate)</option>
                      <option>SIM PAIR & Carrier Activation</option>
                      <option>SIM PAIR, BENCH TEST & Carrier Act</option>
                      <option>VERIZON eSIM PAIR & Carrier Act</option>
                      <option>SIM PAIR w/ STATIC IP Profile</option>
                      <option>CUSTOM CONFIG DEVICE</option>
                      <option>Internal CUC SIM Pairing</option>
                      <option>NO SIM PAIRING</option>
                    </select>
                  </section>

                  <section class="three">
                    <label>SIM Handling</label>
                    <select id="simHandling">
                      <option value="">Select SIM handling</option>
                      <option>Install SIM Card</option>
                      <option>Tape SIM Card to Box</option>
                      <option>Embedded SIM</option>
                      <option>No SIM Card</option>
                    </select>

                    <label style="margin-top:8px">Helix SIM Questionnaire (notes / link)</label>
                    <input id="simQuestionnaire" placeholder="https://docs.google.com/document/d/1t1FRA4-..." />
                  </section>
                </div>
              </div>

              <!-- Licenses -->
              <div data-subpanel="licenses" style="display:none">
                <div class="grid">
                  <section class="three">
                    <label>License Vendor</label><input id="licVendor" />
                    <label style="margin-top:8px">License Duration</label><input id="licDuration" placeholder="e.g., 1 year, 3 years" />
                    <label style="margin-top:8px">Prorated Price</label><input id="licProrated" type="number" step="0.01" />
                  </section>
                  <section class="three">
                    <label>License Key / Simba Code</label><input id="licKey" />
                    <label style="margin-top:8px">New SKU Contact</label><input id="licContact" placeholder="Name / email" />
                  </section>
                </div>
              </div>
            </div>

            <!-- Totals -->
            <div class="totals" id="totalsBox" style="display:none">
              <h4>Totals (current document)</h4>
              <div class="rowline"><span>Lines Subtotal</span><strong id="tLines">$0.00</strong></div>
              <div class="rowline"><span>Accessories</span><strong id="tAcc">$0.00</strong></div>
              <div class="rowline"><span>Services</span><strong id="tSvc">$0.00</strong></div>
              <div class="rowline"><span>Insurance</span><strong id="tIns">$0.00</strong></div>
              <div class="rowline"><span>Tax</span><strong id="tTax">$0.00</strong></div>
              <div class="divider"></div>
              <div class="rowline"><span><strong>Grand Total</strong></span><strong id="tGrand">$0.00</strong></div>
              <div class="tiny" id="taxNote"></div>
            </div>
            <div class="row" id="emailOMInline" style="gap:10px; margin-top:10px; display:none">
            <button class="ghost" onclick="refreshCSVPreview(); openDrawer('drawerEmail')">
                 Email Order Management
             </button>
            </div>
          </section>
        </div>
      </section>

      <!-- MDM -->
      <section class="card" data-panel="mdm" style="display:none">
        <div class="grid">
          <section class="three">
            <h3>MDM & Carrier Subsidy</h3>
            <div class="mdmGrid">

      <!-- top row of pills -->
      <label class="chk-pill mdmHalf">
        <span>Carrier SPF Subsidy</span>
        <input type="checkbox" id="carrierSPF">
      </label>

      <label class="chk-pill mdmHalf">
        <span>ABM (Apple Business Manager)</span>
        <input type="checkbox" id="mdmABM">
      </label>

      <label class="chk-pill mdmHalf">
        <span>Samsung Knox (KME)</span>
        <input type="checkbox" id="mdmKnox">
      </label>

      <label class="chk-pill mdmHalf">
        <span>Android Zero Touch Enrollment</span>
        <input type="checkbox" id="mdmZeroTouch">
      </label>

      <!-- text fields -->
      <div class="field mdmHalf">
        <label>Business Internet Plan Code</label>
        <input id="planCode" />
      </div>

      <div class="field mdmHalf">
        <label>Knox Account #</label>
        <input id="knoxAccount" />
      </div>

      <!-- subsidy verbiage pill -->
      <label class="chk-pill mdmHalf">
        <span>Include Subsidy Verbiage</span>
        <input type="checkbox" id="subsidyNote">
      </label>

      <label class="chk-pill mdmHalf">
        <span>MDM Pro-Services</span>
        <input type="checkbox" id="mdmPro">
      </label>

      <!-- notes -->
      <div class="field mdmFull">
        <label>MDM Notes / Description</label>
        <textarea id="mdmNotes" rows="4"></textarea>
      </div>
    </div>
          </section>
        
          
          <section class="full">
            <div class="row" style="gap:10px">
              <button class="ok" onclick="buildSummary()">Generate Summary</button>
              <button class="ghost" onclick="copySummary()">Copy Summary</button>
              <button class="warn" onclick="validateForm()">Quick Validate</button>
              <button class="ghost" id="btnOpenEmail" onclick="openDrawer('drawerEmail')">Email Order Management</button>
              <button class="bad" onclick="clearAll()">Clear Form</button>
            </div>
            <div id="summary" class="summary-box" style="margin-top:12px"></div>
          </section>
        </div>
      </section>
    </div> <!-- /#intakeTabsWrap -->
  </section>
</div>

<!-- ===== DRAWERS ===== -->

<!-- WCP helper -->
<aside class="drawer" id="drawerWCP" aria-label="WCP Drawer">
  <header><strong>Current Customer — OrderTime Search</strong><button class="ghost" onclick="closeDrawer('drawerWCP')">Close</button></header>
  <div class="content">
    <label class="tiny">Search in OrderTime (opens in a new tab)</label>
    <div class="row"><input id="wcpQuery" placeholder="Type company name…" /><button onclick="openOTSearch()" class="ghost">Search</button></div>
    <div class="divider"></div>
    <div class="tiny">After selecting the customer in OrderTime, paste the exported details below (JSON or key:value). Supports billing, shipping, payment, shipping options.</div>
    <textarea id="wcpPaste" rows="10" style="width:100%;margin-top:8px" placeholder='{
  "company":"AmeriPro Health",
  "billing":{"contact":"John","phone":"555-1111","email":"billing@acme.com","street":"1 Main","suite":"Ste 100","city":"Phila","state":"PA","zip":"19104"},
  "shipping":{"company":"Acme WH","contact":"Jane","phone":"555-2222","email":"wh@acme.com","street":"500 Dock","suite":"","city":"Phila","state":"PA","zip":"19112"},
  "payment":{"method":"Net Terms","terms":"Net 30","taxExempt":true,"agreement":false},
  "shippingOptions":{"pay":"Prepaid","speed":"Ground","shortShip":"No"},
  "carrierRep":{"name":"Verizon Rep","email":"vrep@vz.com"},
  "rep":{"primary":"Chris Samaras","secondary":"—"}
}'></textarea>
    <div class="row" style="gap:10px;margin-top:8px"><button class="ok" onclick="applyPastedCustomer('wcpPaste')">Apply to Form</button><button class="ghost" onclick="fillWCPExample()">Load Example</button></div>
  </div>
</aside>

<!-- NEW Customer invite -->
<aside class="drawer" id="drawerNew" aria-label="New Customer Drawer">
  <header><strong>NEW Customer — SSP Invite</strong><button class="ghost" onclick="closeDrawer('drawerNew')">Close</button></header>
  <div class="content">
    <label>Customer Email To:</label><input id="sspTo" type="email" placeholder="customer@email.com" />
    <label style="margin-top:8px">Subject</label><input id="sspSubject" />
    <label style="margin-top:8px">Body</label><textarea id="sspBody" rows="12"></textarea>

    <div class="row" style="gap:10px;margin-top:8px">
      <button class="ok" onclick="copySSP()">Copy to Clipboard</button>
      <button class="ghost" onclick="composeSSP()">Open Mail Client</button>
      <button class="ok" onclick="composeSSPInGmail()">Open in Gmail</button>
    </div>

    <div class="tiny">Primary Rep & Billing Contact should be set. Template auto-fills from the rep database.</div>
  </div>
</aside>

<!-- Email OM with CSV -->
<aside class="drawer" id="drawerEmail" aria-label="Email OM Drawer">
  <header><strong>Email Order Management — CSV Summary</strong><button class="ghost" onclick="closeDrawer('drawerEmail')">Close</button></header>
  <div class="content">
    <label>To</label>
    <input id="emailTo" type="email" value="service@connectuscorp.com" />
    <label style="margin-top:8px">Subject</label>
    <input id="emailSubject" value="New Intake — CSV Summary" />

    <div class="divider"></div>
    <label>CSV Preview (included in email body)</label>
    <textarea id="csvPreview" rows="14" style="width:100%;font-family:ui-monospace,Consolas,monospace"></textarea>

    <div class="row" style="gap:10px;margin-top:12px">
      <button onclick="copyCSV()">Copy CSV</button>
      <button onclick="downloadSaleOrderHeaderCSV()">Sale Order Header CSV</button>
      <button onclick="downloadSaleOrderLineCSV()">Sale Order Order Line CSV</button>
      <!-- <button onclick="openInGmail(true)">Open in Gmail (CSV in body)</button> -->
<button onclick="openInGmail(false)">Open in Gmail (no CSV)</button>

    </div>

    <div class="tiny" style="margin-top:8px">
      Or use a direct mailto link:
      <a id="mailtoHref" href="#" target="_blank" rel="noopener">Open in default mail app</a>
    </div>
  </div>
</aside>

<script>
/* ---------- Gmail compose helpers ---------- */
function openGmailCompose({to, subject, body}) {
  const base = "https://mail.google.com/mail/?view=cm&fs=1";
  const url = `${base}&to=${encodeURIComponent(to || "")}` +
              `&su=${encodeURIComponent(subject || "")}` +
              `&body=${encodeURIComponent(body || "")}`;
  const win = window.open(url, "_blank", "noopener,noreferrer");
  if (!win) alert("Popup blocked. Please allow popups for this site to open Gmail.");
}
function openGmailWithCSV() {
  const toRaw   = document.getElementById('emailTo')?.value || 'service@connectuscorp.com';
  const subjRaw = document.getElementById('emailSubject')?.value || 'New Intake — CSV Summary';
  const csv     = document.getElementById('csvPreview')?.value || buildCSV();
  const header = `Hello Order Management,\n\nPlease find the intake details below in CSV format.\n\n`;
  const footer = `\n\n— ConnectUS Intake`;
  const body   = `${header}${csv}${footer}`;
  openGmailCompose({ to: toRaw, subject: subjRaw, body });
}
function openGmailNoCSV() {
  const toRaw     = document.getElementById('emailTo')?.value || 'service@connectuscorp.com';
  const subjRaw   = document.getElementById('emailSubject')?.value || 'New Intake — Summary';
  const summary   = (document.getElementById('summary')?.textContent || '').trim() || '(no summary available)';
  const company   = (document.getElementById('billCompany')?.value || '').trim();
  const header    = `Hello Order Management,\n\n${company ? `Company: ${company}\n` : ''}Below is the intake summary:\n\n`;
  const footer    = `\n\n— ConnectUS Intake`;
  const body      = `${header}${summary}${footer}`;
  openGmailCompose({ to: toRaw, subject: subjRaw, body });
}

// --- Button shims to match your drawer's onclicks ---
function openInGmail(includeCSV){
  if (includeCSV) return openGmailWithCSV();
  return openGmailNoCSV();
}
function copyCSV(){
  return copyCSVToClipboard();
}

/* --- Auto-width so inputs show ALL characters --- */
const _sizer = document.createElement('span');
_sizer.className = 'input-sizer';
document.body.appendChild(_sizer);

function fitInputWidth(inp){
  if(!inp) return;
  const cs = getComputedStyle(inp);
  _sizer.style.font = cs.font;
  _sizer.style.fontSize = cs.fontSize;
  _sizer.style.letterSpacing = cs.letterSpacing;
  _sizer.textContent = (inp.value || inp.placeholder || '').replace(/ /g, '\u00A0');
  const pad = (parseFloat(cs.paddingLeft)||0) + (parseFloat(cs.paddingRight)||0);
  const border = (parseFloat(cs.borderLeftWidth)||0) + (parseFloat(cs.borderRightWidth)||0);
  const w = Math.max(80, _sizer.offsetWidth + pad + border + 2);
  inp.style.width = w + 'px';
}

// run for all current/future inputs in the Items table
function wireAutoWidths(row){
  (row ? row.querySelectorAll('input') : document.querySelectorAll('#itemsTbl input'))
    .forEach(inp => {
      fitInputWidth(inp);
      inp.addEventListener('input', () => fitInputWidth(inp));
      inp.addEventListener('focus', () => fitInputWidth(inp));
      inp.addEventListener('blur',  () => fitInputWidth(inp));
    });
}
wireAutoWidths();

// make addRow() also wire auto-widths for new inputs
const _origAddRow = addRow;
addRow = function(prefill){
  _origAddRow(prefill);
  const last = document.querySelector('#itemsBody tr:last-child');
  if (last) wireAutoWidths(last);

  // If user picked "Hardware + Pro Services", prime services for convenience
  if (ORDER_MODE === 'new' && ORDER_TYPE === 'pro') {
    document.getElementById('subtabsArea').style.display = '';
    document.getElementById('subtabPanels').style.display = '';
    document.querySelector('.subtab[data-sub="services"]')?.click();
    const svcEnabled = document.getElementById('svcEnabled');
    if (svcEnabled && !svcEnabled.checked) { svcEnabled.checked = true; recalcServices(); }
  }
};

/* ---------- Insurance show/hide ---------- */
function isInsuranceEnabled(){
  return (document.getElementById('insEnabled')?.value || '').toLowerCase() === 'yes';
}
function toggleInsuranceFields(){
  const on = isInsuranceEnabled();
  const box = document.getElementById('insFields');
  if (box) box.style.display = on ? '' : 'none';
  if (!on) ['insPlan','insDed','insTerm','insSell','insCost'].forEach(id => setVal(id,''));
  refreshTotals();
}

/* Reliable mailto opener (used by mailto paths) */
function openMailto(url){
  const a = document.createElement('a');
  a.href = url; a.style.display = 'none'; a.setAttribute('target', '_self');
  document.body.appendChild(a); a.click(); a.remove();
}

/* ===== CONFIG ===== */
const ORDERTIME_SEARCH_BASE = "https://ordertime.yourdomain.com/customers/search"; // <- replace
const TAX_RATE = 0.07;
const RATE_PER_MIN = 0.80;
const SSP_INVITE_SUBJECT = "Set up your ConnectUS Self-Service Portal (SSP)";

/* ===== Rep Database (localStorage-backed) ===== */
const LS_REPS_KEY = "CUC_REPS_V1";
const BASE_TEMPLATES = {
  "Lucas Currin": ` Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=lucas-currin 

{{Current Email}} will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
 Lucas Currin `,
  "Anthony Liace": ` Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=anthony-liace 

{{Current Email}} will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
Anthony Liace

 `,
  "John Tropeano": `  Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=john-tropeano 

{{Current Email}} will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
John Tropeano

 `,
  "Greg Flannigan": ` Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=greg-flannigan 

{{Current Email}} will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
Greg Flannigan

 `,
  "Heath Pospisil": ` Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=heath-pospisil 

{{Current Email}} will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
Heath Pospisil

 `,
  "Orlando": ` Hello {{ Customer First Name}}, 

We are excited to share that we have created a self service customer portal to make engaging with ConnectUs an easier and more seamless experience. 

From this portal you will be able to: 
View Order Statuses See order historyView Tracking InformationRetrieve IMEI & Sim Information (When applicable)Manage Billing & Shipping AddressesView & download invoicesAnd More! 

Click here to create your user name and password:  https://connectuscorp.com/my-account/?salep-rep=orlando-calderon 

{{Current Email}} will serve as the admin for this account. You can add additional users once you register. If you would like to change the admin email, please email me. 

This is only the beginning! In the not so distant future, you will be able to place orders directly  from the portal which will save you time and provide you information you need in real time. 

Our goal is to save you time and provide you the information you need on-demand. 

We welcome you to provide any feedback you would like to see for future improvements or features. We will continually strive to improve your interactions with ConnectUs to make doing business with us an enjoyable experience. 

Further instructions to follow once your account is created. 

If we can help in any way, please do not hesitate to reach out. 

Your business is greatly appreciated!

With Warmest Regards,
Orlando

 `
};

function loadReps(){
  let reps = [];
  try{ reps = JSON.parse(localStorage.getItem(LS_REPS_KEY)||"[]"); }catch(_){}
  if(!reps || reps.length===0){
    reps = [
      {name:"Lucas Currin", email:"lucas.currin@connectuscorp.com", slug:"lucas-currin", template:BASE_TEMPLATES["Lucas Currin"]},
      {name:"Anthony Liace", email:"anthony.liace@connectuscorp.com", slug:"anthony-liace", template:BASE_TEMPLATES["Anthony Liace"]},
      {name:"John Tropeano", email:"john.tropeano@connectuscorp.com", slug:"john-tropeano", template:BASE_TEMPLATES["John Tropeano"]},
      {name:"Greg Flannigan", email:"greg.flannigan@connectuscorp.com", slug:"greg-flannigan", template:BASE_TEMPLATES["Greg Flannigan"]},
      {name:"Heath Pospisil", email:"heath.pospisil@connectuscorp.com", slug:"heath-pospisil", template:BASE_TEMPLATES["Heath Pospisil"]},
      {name:"Orlando", email:"orlando.calderon@connectuscorp.com", slug:"orlando-calderon", template:BASE_TEMPLATES["Orlando"]}
    ];
    localStorage.setItem(LS_REPS_KEY, JSON.stringify(reps));
  }
  return reps;
}
function saveReps(reps){ localStorage.setItem(LS_REPS_KEY, JSON.stringify(reps||[])); }
function getReps(){ return loadReps(); }
function getRepByName(name){ return getReps().find(r=>r.name===name); }

/* ===== Main Tabs ===== */
// --- Robust main-tabs switcher (delegated) ---
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.mtab');   // catch clicks on .mtab or its children
  if (!btn) return;

  const key = btn.dataset.main;            // e.g. "reps" or "intake"
  if (!key) return;

  // Toggle active state on tabs
  document.querySelectorAll('.mtab').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');

  // Toggle the panels
  document.querySelectorAll('[data-mainpanel]').forEach(p=>p.classList.remove('active'));
  const panel = document.querySelector(`[data-mainpanel="${key}"]`);
  if (panel) panel.classList.add('active');

  // If reps tab is opened, refresh rep list
  if (key === 'reps' && typeof renderRepList === 'function') {
    renderRepList();
  }
});


/* ===== Intake Tabs + Stepper ===== */
document.addEventListener('click', (e)=>{
  const t = e.target;
  if (t.classList.contains('tab')) {
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('[data-panel]').forEach(p=>p.style.display='none');
    t.classList.add('active');
    document.querySelector(`[data-panel="${t.dataset.tab}"]`).style.display='';
    document.querySelectorAll('#stepper .step').forEach(x=>x.classList.toggle('active', x.getAttribute('data-goto')===t.dataset.tab));
  }
});
document.querySelectorAll('#stepper .step').forEach(s=>{
  s.addEventListener('click', ()=>document.querySelector(`.tab[data-tab="${s.getAttribute('data-goto')}"]`)?.click());
});

/* ===== Drawers ===== */
function openDrawer(id){ document.getElementById(id).classList.add('active'); }
function closeDrawer(id){ document.getElementById(id).classList.remove('active'); }

/* WCP open behavior */
document.getElementById('flagWCP').addEventListener('change', e=>{ /* no-op */ });
document.getElementById('flagCurrentCustomer').addEventListener('change', e=>{ if(e.target.checked) openDrawer('drawerWCP'); });
document.getElementById('flag3PL').addEventListener('change', e=>{ if(e.target.checked) openDrawer('drawerWCP'); });

/* NEW CUSTOMER: open drawer + auto-build + compose */
document.getElementById('flagNewCustomer').addEventListener('change', e=>{
  if(e.target.checked){
    refreshSSPTemplate();
    openDrawer('drawerNew');
    tryAutoComposeSSP();
  }
});

/* ===== WCP helper ===== */
function openOTSearch(){
  const q=(document.getElementById('wcpQuery').value||document.getElementById('billCompany').value||'').trim();
  const url=q?`${ORDERTIME_SEARCH_BASE}?q=${encodeURIComponent(q)}`:ORDERTIME_SEARCH_BASE;
  window.open(url,'_blank');
}
function applyPastedCustomer(textareaId){
  const raw=document.getElementById(textareaId).value.trim();
  if(!raw){ alert('Paste customer details first.'); return; }
  let data={};
  try{ data=JSON.parse(raw); }
  catch(_){ raw.split(/\r?\n/).forEach(line=>{ const m=line.match(/^([^:]+):\s*(.*)$/); if(!m)return; setByPath(data,m[1].trim(),m[2].trim()); }); }

  setVal('billCompany', pick(data.company, data.billing?.company));
  setVal('billContact', pick(data.billing?.contact)); setVal('billPhone', pick(data.billing?.phone));
  setVal('billEmail', pick(data.billing?.email)); setVal('billStreet', pick(data.billing?.street));
  setVal('billSuite', pick(data.billing?.suite)); setVal('billCity', pick(data.billing?.city));
  setVal('billState', pick(data.billing?.state)); setVal('billZip', pick(data.billing?.zip));

  setVal('shipCompany', pick(data.shipping?.company)); setVal('shipContact', pick(data.shipping?.contact));
  setVal('shipPhone', pick(data.shipping?.phone)); setVal('shipEmail', pick(data.shipping?.email));
  setVal('shipStreet', pick(data.shipping?.street)); setVal('shipSuite', pick(data.shipping?.suite));
  setVal('shipCity', pick(data.shipping?.city)); setVal('shipState', pick(data.shipping?.state)); setVal('shipZip', pick(data.shipping?.zip));

  const pm=pick(data.payment?.method); if(pm) selectByTextExact('payMethod', pm);
  setVal('payTerms', pick(data.payment?.terms));
  document.getElementById('taxExempt').checked=!!data.payment?.taxExempt;
  document.getElementById('hasAgreement').checked=!!data.payment?.agreement;

  const so=data.shippingOptions||{};
  if(so.pay) selectByTextExact('shipPay', so.pay);
  if(so.speed) selectByTextExact('shipSpeed', so.speed);
  if(so.shortShip) selectByTextExact('shortShip', so.shortShip);

  setVal('carrierRepName', pick(data.carrierRep?.name)); setVal('carrierRepEmail', pick(data.carrierRep?.email));

  const r1=pick(data.rep?.primary); if(r1) selectByTextExact('rep1', r1);
  const r2=pick(data.rep?.secondary); if(r2) selectByTextExact('rep2', r2);

  closeDrawer('drawerWCP');
  refreshTotals();
}
function fillWCPExample(){
  document.getElementById('wcpQuery').value='AmeriPro Health';
  document.getElementById('wcpPaste').value=JSON.stringify(DEMO_CUSTOMER_FULL, null, 2);
}

/* ===== SSP invite ===== */
function sspInviteBody(rep,company){
  return `Hi there,

We’re getting your account set up with ConnectUS. Please register in our Self-Service Portal (SSP) so we can finalize your quote/order.

Registration link:
https://connectuscorp.com/my-account/?salep-rep=${encodeURIComponent((rep||'').toLowerCase().replace(/\s+/g,'-'))}

Company: ${company||""}

Thanks,
${rep||"ConnectUS Sales"}
ConnectUS Corp`;
}
function getCustomerFirstName(){
  const full=(document.getElementById('billContact')?.value||'').trim();
  if(!full) return '';
  const parts=full.split(/\s+/);
  return parts[0]||'';
}
function refreshSSPTemplate(){
  const repName=(document.getElementById('rep1').value||'').trim();
  const rep = getRepByName(repName);
  const firstName = getCustomerFirstName() || 'there';
  const custEmail = (document.getElementById('billEmail').value||'').trim();

  let body;
  if(rep){
    body = (rep.template||'')
      .replace(/\{\{\s*Customer First Name\s*\}\}/g, firstName)
      .replace(/\{\{\s*Current Email\s*\}\}/g, custEmail || '(your email)');
    if(rep.slug){
      body = body.replace(/(my-account\/\?salep-rep=)[^\s]+/g, `$1${rep.slug}`);
    }
  }else{
    body = sspInviteBody(repName, (document.getElementById('billCompany').value||''));
  }

  document.getElementById('sspSubject').value=SSP_INVITE_SUBJECT;
  document.getElementById('sspBody').value=body;
  document.getElementById('sspTo').value=custEmail;
}
function tryAutoComposeSSP(){
  const to=(document.getElementById('billEmail').value||'').trim();
  const repName=(document.getElementById('rep1').value||'').trim();
  if(!repName){ alert('Select a Primary Sales Rep first.'); return; }
  if(!to){ alert('Add Billing Email before sending the invite.'); return; }
  refreshSSPTemplate();
  composeSSP();
}
function copySSP(){
  const text=`To: ${document.getElementById('sspTo').value||'(add recipient)'}\nSubject: ${document.getElementById('sspSubject').value}\n\n${document.getElementById('sspBody').value}`;
  navigator.clipboard.writeText(text);
  alert('SSP email copied.');
}
function composeSSP(){
  const to=encodeURIComponent(document.getElementById('sspTo').value||'');
  const subj=encodeURIComponent(document.getElementById('sspSubject').value||'');
  const body=encodeURIComponent(document.getElementById('sspBody').value||'');
  window.location.href=`mailto:${to}?subject=${subj}&body=${body}`;
}
function composeSSPInGmail(){
  const to = (document.getElementById('sspTo')?.value || '').trim();
  const subject = (document.getElementById('sspSubject')?.value || SSP_INVITE_SUBJECT).trim();
  const body = (document.getElementById('sspBody')?.value || '').trim();
  if(!to){ alert('Add a recipient email first.'); return; }
  const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(gmailUrl, '_blank', 'noopener');
}

/* ===== Items & example ===== */
const QUOTE_REQUEST_MAP={
  "QR-2025-00123":{
    desc:'NOVATEL JETPACK MIFI LTE HOTSPOT 6620L VERIZON LOCKED BLACK', model:'6620L', color:'Silver', sku:'NV-6620LV9A29', qty:25, net:'LTE', carrier:'Verizon',
    payout:50, msrp:429.99, disc:10, sell:386.99, cond:'New', stock:'Yes', vendor:'Ingram', cost:330.00,
    deal:'DLL-$310 / DR-12345', hold:'RES-9981', leadtime:'2-3 wks', eol:'No',
    accessory:{ sku:'CASE-IPAD10-RUG', desc:'Rugged Case', qty:1, sell:29.99 },
    insurance:{ plan:'AKKO', ded:'$100', term:'2 years', sell:69.00 },
    services:{ enabled:true, tier:1 },
    sim:{ card:'n/a', pairing:'Option 1', handling:'Preinstall', questionnaire:'https://example.com/helix' },
    lic:{ vendor:'Jamf', duration:'1 year', prorated:'12.00', key: 'SIMBA-ABC123', contact:'licenses@vendor.com' }
  }
};

/* ===== DOM helpers ===== */
function el(tag,attrs={},children=[]){
  const e=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') e.className=v;
    else if(k==='html') e.innerHTML=v;
    else if(k==='onclick') e.onclick=v;
    else e.setAttribute(k,v);
  });
  (children||[]).forEach(c=>e.appendChild(c));
  return e;
}

/* ===== Order Mode Gate ===== */
let ORDER_MODE = null; // 'new' | 'clone'
let ORDER_TYPE = null; // 'hardware' | 'pro'

function lockIntakeTabs() {
  document.getElementById('intakeTabsWrap').style.display = 'none';
  document.getElementById('stepper').style.display = 'none';
  // Keep Customer panel active but hidden until unlocked
  document.querySelectorAll('[data-panel]').forEach(p=>p.style.display='none');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector('.tab[data-tab="customer"]')?.classList.add('active');
}

function unlockIntakeTabs() {
  document.getElementById('intakeTabsWrap').style.display = '';
  document.getElementById('stepper').style.display = '';
  // Show Customer by default
  document.querySelector('[data-panel="customer"]').style.display='';
  document.querySelectorAll('#stepper .step').forEach(x=>x.classList.toggle('active', x.getAttribute('data-goto')==='customer'));
}

function updateOrderModeUI() {
  const mode = ORDER_MODE;
  const typeRow = document.getElementById('orderTypeRow');
  const cloneRow = document.getElementById('cloneVerifyRow');
  if (mode === 'new') {
    typeRow.style.display = '';
    cloneRow.style.display = 'none';
    lockIntakeTabs();
  } else if (mode === 'clone') {
    typeRow.style.display = 'none';
    cloneRow.style.display = '';
    lockIntakeTabs();
  } else {
    typeRow.style.display = 'none';
    cloneRow.style.display = 'none';
    lockIntakeTabs();
  }
}

/* ===== Items: addRow (base) ===== */
function addRow(prefill){
  const tr=el('tr');
  const cols=[
    {key:'desc', ph:'e.g., Apple iPad 256GB Space Gray'},
    {key:'model', ph:'Model / Part #'},
    {key:'color', ph:'Color'},
    {key:'sku', ph:'ORDERTIME-SKU'},
    {key:'qty', ph:'Qty', type:'number', min:1, val:1},
    {key:'net', ph:'LTE / Wi-Fi / Both'},
    {key:'carrier', ph:'Carrier'},
    {key:'payout', ph:'$', type:'number', step:'0.01'},
    {key:'msrp', ph:'$', type:'number', step:'0.01'},
    {key:'disc', ph:'%', type:'number', step:'0.01'},
    {key:'sell', ph:'$', type:'number', step:'0.01'},
    {key:'cond', ph:'New / CPO'},
    {key:'stock', ph:'Yes/No'},
    {key:'vendor', ph:'Vendor'},
    {key:'cost', ph:'$', type:'number', step:'0.01'},
    {key:'deal', ph:'SPA Price / Deal Reg #'},
    {key:'hold', ph:'Hold/Reservation #'},
    {key:'instructions', ph:'Line Instructions'},
    {key:'leadtime', ph:'Delivery Lead Time'},
    {key:'eol', ph:'EOL Confirm (Yes/No)'}
  ];
  cols.forEach(c=>{
    const td=el('td');
    const inp=el('input',{placeholder:c.ph});
    inp.dataset.key=c.key;
    if(c.type) inp.type=c.type;
    if(c.min!==undefined) inp.min=c.min;
    if(c.step) inp.step=c.step;
    if(c.val!==undefined) inp.value=c.val;
    inp.addEventListener('input', refreshTotals);
    td.appendChild(inp);
    tr.appendChild(td);
  });
  const rm=el('td',{},[
  el('button',{class:'bad',onclick:()=>{ tr.remove(); refreshTotals(); maybeShowEmailOMInline(); }},[document.createTextNode('Remove')])
]);

  tr.appendChild(rm);
  document.getElementById('itemsBody').appendChild(tr);

  if(prefill){
    [...tr.querySelectorAll('input')].forEach(inp=>{
      const k=inp.dataset.key; if(prefill[k]!==undefined) inp.value=prefill[k];
    });
    showSubtabs();

    if(prefill.accessory){
      setVal('accSku',prefill.accessory.sku); setVal('accDesc',prefill.accessory.desc);
      setVal('accQty',prefill.accessory.qty); setVal('accSell',prefill.accessory.sell);
    }

    if (prefill.insurance) {
      selectByTextExact('insPlan', prefill.insurance.plan);
      selectByTextExact('insDed',  prefill.insurance.ded);
      selectByTextExact('insTerm', prefill.insurance.term);
      setVal('insSell', prefill.insurance.sell);
      if (prefill.insurance.cost) setVal('insCost', prefill.insurance.cost);
      selectByTextExact('insEnabled','Yes');
      toggleInsuranceFields();
    }

    if(prefill.services){
      document.getElementById('svcEnabled').checked=!!prefill.services.enabled;
      document.getElementById('svcTier').value=String(prefill.services.tier||0);
      tierToMinutes(); recalcServices();
    }
    if(prefill.sim){
      setVal('simCard',prefill.sim.card);
      setVal('pairingOption',prefill.sim.pairing);
      setVal('simHandling',prefill.sim.handling);
      setVal('simQuestionnaire',prefill.sim.questionnaire);
    }
    if(prefill.lic){
      setVal('licVendor',prefill.lic.vendor); setVal('licDuration',prefill.lic.duration);
      setVal('licProrated',prefill.lic.prorated); setVal('licKey',prefill.lic.key); setVal('licContact',prefill.lic.contact);
    }
  }
  document.getElementById('totalsBox').style.display='';
  refreshTotals();
  maybeShowEmailOMInline();
}

/* ===== Helpers used above (declared later in original, but needed globally) ===== */
function getItems(){
  const rows=[...document.querySelectorAll('#itemsBody tr')];
  return rows.map(r=>{
    const obj={}; [...r.querySelectorAll('input')].forEach(i=>obj[i.dataset.key]=i.value.trim());
    return obj;
  }).filter(o=>Object.values(o).some(v=>v));
}
function getCurrentRowQty(){
  const lastRow=document.querySelector('#itemsBody tr:last-child');
  const qty=lastRow?parseFloat(lastRow.querySelector('input[data-key="qty"]')?.value||'0'):0;
  return isFinite(qty)?qty:0;
}

/* ===== Subtabs ===== */
function showSubtabs(){
  document.getElementById('subtabsArea').style.display='';
  document.getElementById('subtabPanels').style.display='';
}
document.querySelectorAll('.subtab').forEach(s=>{
  s.addEventListener('click',()=>{
    document.querySelectorAll('.subtab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('[data-subpanel]').forEach(p=>p.style.display='none');
    s.classList.add('active');
    document.querySelector(`[data-subpanel="${s.dataset.sub}"]`).style.display='';
  });
});

/* ===== Accessory Brick + Cable ===== */
document.getElementById('bcInclude').addEventListener('change', e=>{
  if(e.target.checked){
    if(!val('accSku')) setVal('accSku','PWR-BRICK-CABLE');
    if(!val('accDesc')) setVal('accDesc','Power Brick + Cable Kit');
    if(!val('accQty')) setVal('accQty','1');
    if(!val('accSell')) setVal('accSell','0.00');
  }
  refreshTotals();
});

/* ===== Services logic ===== */
document.getElementById('svcTier').addEventListener('change', ()=>{ tierToMinutes(); recalcServices(); });
document.getElementById('svcMinutes').addEventListener('input', recalcServices);
document.getElementById('svcEnabled').addEventListener('change', recalcServices);
document.getElementById('itemsBody').addEventListener('input', e=>{
  if(e.target?.dataset?.key==='qty') recalcServices();
});
function tierToMinutes(){
  const tier=parseInt(document.getElementById('svcTier').value||'0',10);
  const minutes = tier===0 ? 5 : tier*15;
  document.getElementById('svcMinutes').value = minutes;
  document.getElementById('svcSKU').value = `PROSERV-TIER-${tier}`;
}

function recalcServices(){
  const enabled = document.getElementById('svcEnabled').checked;
  const minutes = parseFloat(document.getElementById('svcMinutes').value||'0');
  const per = enabled ? minutes * RATE_PER_MIN : 0;
  setVal('svcCostPer', per.toFixed(2));
  const qty = getCurrentRowQty();
  setVal('svcCostTotal', (per*qty).toFixed(2));
  if(enabled && !document.getElementById('svcSKU').value){
    document.getElementById('svcSKU').value=`PROSERV-TIER-${parseInt(document.getElementById('svcTier').value||'0',10)}`;
  }
  refreshTotals();
}

/* ===== Totals ===== */
function parseNum(x){ const n=parseFloat(String(x).replace(/[^0-9.\-]/g,'')); return isFinite(n)?n:0; }
function fmt(n){ return `$${(Math.round(n*100)/100).toFixed(2)}`; }

function computeTotals(){
  const items=getItems();
  let linesSubtotal=0;
  items.forEach(l=>{
    const qty=parseNum(l.qty), price=parseNum(l.sell);
    linesSubtotal += qty*price;
  });

  const qty = getCurrentRowQty();
  const accQty=parseNum(val('accQty')); const accSell=parseNum(val('accSell'));
  const accTotal = accQty*accSell*qty;

  const svcEnabled=document.getElementById('svcEnabled').checked;
  const svcPer=parseNum(val('svcCostPer'));
  const svcTotal = svcEnabled ? svcPer*qty : 0;

  const insSell=parseNum(val('insSell'));
  const insTotal = insSell*qty;

  const taxExempt = document.getElementById('taxExempt').checked;
  const taxable = linesSubtotal + accTotal + svcTotal + insTotal;
  const tax = taxExempt ? 0 : taxable*TAX_RATE;
  const grand = taxable + tax;

  return {linesSubtotal, accTotal, svcTotal, insTotal, tax, grand, taxable, taxExempt};
}
function refreshTotals(){
  const t=computeTotals();
  document.getElementById('tLines').textContent=fmt(t.linesSubtotal);
  document.getElementById('tAcc').textContent=fmt(t.accTotal);
  document.getElementById('tSvc').textContent=fmt(t.svcTotal);
  document.getElementById('tIns').textContent=fmt(t.insTotal);
  document.getElementById('tTax').textContent=fmt(t.tax);
  document.getElementById('tGrand').textContent=fmt(t.grand);
  document.getElementById('totalsBox').style.display='';
  document.getElementById('taxNote').textContent = t.taxExempt ? 'Tax Exempt: tax not applied.' : `Tax rate: ${(TAX_RATE*100).toFixed(2)}%`;

      maybeShowEmailOMInline();

}


function maybeShowEmailOMInline(){
  const host = document.getElementById('emailOMInline');
  if (!host) return;

  const isHardwareOnly = (ORDER_MODE === 'new' && ORDER_TYPE === 'hardware');
  const hasItems = (typeof getItems === 'function') ? getItems().length > 0 : false;

  // Show only for New → Hardware only AND at least one line item
  host.style.display = (isHardwareOnly && hasItems) ? '' : 'none';
}

/* ===== Summary / Validation ===== */
function val(id){return (document.getElementById(id)?.value||'').trim()}
function bool(id){return document.getElementById(id)?.checked}
function buildSummary(){
  const docType=[...document.querySelectorAll('input[name="doctype"]')].find(x=>x.checked)?.value||'QUOTE';
  const lines=getItems();
  const t=computeTotals();
  const parts=[];
  parts.push(`DOCUMENT: ${docType}`);
  parts.push(`Order Mode: ${ORDER_MODE||'—'}${ORDER_MODE==='new' ? ` (${ORDER_TYPE||'—'})` : ''}`);
  if (ORDER_MODE==='clone') {
    parts.push(`Clone Verified: Customer=${bool('vCustomer')?'Yes':'No'}, Shipping=${bool('vShipping')?'Yes':'No'}, Items=${bool('vItems')?'Yes':'No'}, MDM=${bool('vMDM')?'Yes':'No'}`);
  }
  parts.push(`Flags: ${bool('flagNewCustomer')?'NEW Customer; ':''}${bool('flagWCP')?'WCP; ':''}${bool('flagCurrentCustomer')?'Current Customer; ':''}${bool('flag3PL')?'3PL; ':''}`.replace(/; $/,''));
  parts.push('');
  parts.push('SALES / PARTNER');
  parts.push(`- Primary Rep: ${val('rep1')||'—'}; Secondary: ${val('rep2')||'—'}; Referral: ${val('refPartner')||'—'}`);
  parts.push(`- Carrier Rep: ${val('carrierRepName')} <${val('carrierRepEmail')||'—'}>; CUC Rep: ${val('cucRep')||'—'}`);
  parts.push('');
  parts.push('BILLING');
  parts.push(`- ${val('billCompany')} — ${val('billContact')} (${val('billPhone')}) <${val('billEmail')}>`);
  parts.push(`- ${val('billStreet')} ${val('billSuite')}, ${val('billCity')}, ${val('billState')} ${val('billZip')}`);
  parts.push('');
  parts.push('PAYMENT');
  parts.push(`- Method: ${val('payMethod')||'—'}; Terms: ${val('payTerms')||'—'}; Agreement: ${bool('hasAgreement')?'Yes':'No'}; Tax Exempt: ${bool('taxExempt')?'Yes':'No'}`);
  parts.push('');
  parts.push('SHIPPING');
  parts.push(`- ${val('shipCompany')} — ${val('shipContact')} (${val('shipPhone')}) <${val('shipEmail')}> ${bool('resShip')?'[Residence]':''}`);
  parts.push(`- ${val('shipStreet')} ${val('shipSuite')}, ${val('shipCity')}, ${val('shipState')} ${val('shipZip')}`);
  parts.push(`- Options: Pay ${val('shipPay')||'—'}; Speed ${val('shipSpeed')||'—'}; Short Ship ${val('shortShip')||'—'}; Req ${val('reqShipDate')||'—'}; Expected ${val('expShipDate')||'—'}`);
  parts.push('');
  parts.push('LINES');
  if(lines.length===0){ parts.push('  (none)'); }
  lines.forEach((l,i)=>parts.push(`  ${i+1}. ${l.desc||'—'} | Model ${l.model||'—'} | Color ${l.color||'—'} | SKU ${l.sku||'—'} | Qty ${l.qty||'—'} | ${l.net||'—'} | ${l.carrier||'—'} | Sell $${l.sell||'—'} | ${l.cond||'—'} | In-Stock ${l.stock||'—'} | Vendor ${l.vendor||'—'} | Cost $${l.cost||'—'} | Deal ${l.deal||'—'} | Hold ${l.hold||'—'} | Lead ${l.leadtime||'—'} | EOL ${l.eol||'—'}`));
  parts.push('');
  parts.push('ACCESSORY / SERVICES / INSURANCE (most-recent item)');
  parts.push(`- Acc: Brick+Cable ${document.getElementById('bcInclude').checked?'Yes':'No'} | SKU ${val('accSku')||'—'} | ${val('accDesc')||'—'} | Qty/Unit ${val('accQty')||0} | Sell $${val('accSell')||'—'}`);
  parts.push(`- Svc: Included ${bool('svcEnabled')?'Yes':'No'} | Tier ${val('svcTier')||'0'} | Minutes ${val('svcMinutes')||'0'} | SKU ${val('svcSKU')||'—'} | $/device ${val('svcCostPer')||'0.00'}`);
  parts.push(`- Ins: Plan ${val('insPlan')||'None'} | Ded ${val('insDed')||'—'} | Term ${val('insTerm')||'—'} | Sell $${val('insSell')||'—'}`);
  parts.push('');
  parts.push('SIM / PAIRING (most-recent item)');
  parts.push(`- SIM ${val('simCard')||'—'} | Pairing ${val('pairingOption')||'—'} | Handling ${val('simHandling')||'—'} | Helix ${val('simQuestionnaire')||'—'}`);
  parts.push('');
  parts.push('LICENSES (most-recent item)');
  parts.push(`- Vendor ${val('licVendor')||'—'} | Duration ${val('licDuration')||'—'} | Prorated $${val('licProrated')||'—'} | Key ${val('licKey')||'—'} | Contact ${val('licContact')||'—'}`);
  parts.push('');
  parts.push('MDM & CARRIER SUBSIDY');
  parts.push(`- Carrier SPF: ${bool('carrierSPF')?'Yes':'No'} | Plan Code: ${val('planCode')||'—'} | Subsidy Verbiage: ${bool('subsidyNote')?'Yes':'No'}`);
  parts.push(`- ABM: ${bool('mdmABM')?'Yes':'No'} | Knox (KME): ${bool('mdmKnox')?'Yes':'No'} | Knox Account #: ${val('knoxAccount')||'—'} | Zero Touch: ${bool('mdmZeroTouch')?'Yes':'No'} | MDM Pro: ${bool('mdmPro')?'Yes':'No'}`);
  parts.push(`- MDM Notes: ${val('mdmNotes')||'—'}`);
  parts.push('');
  parts.push('TOTALS');
  parts.push(`- Lines Subtotal: ${fmt(t.linesSubtotal)}`);
  parts.push(`- Accessories: ${fmt(t.accTotal)}; Services: ${fmt(t.svcTotal)}; Insurance: ${fmt(t.insTotal)}`);
  parts.push(`- Tax: ${fmt(t.tax)} ${t.taxExempt?'(Exempt)':''}`);
  parts.push(`= GRAND TOTAL: ${fmt(t.grand)}`);

  document.getElementById('summary').textContent=parts.join('\n');
  refreshCSVPreview();
}
function copySummary(){ if(!document.getElementById('summary').textContent) buildSummary(); navigator.clipboard.writeText(document.getElementById('summary').textContent||''); }
function validateForm(){
  const errs=[];
  if(!val('billCompany')) errs.push('Billing: Company Name');
  if(!val('billEmail')) errs.push('Billing: Email');
  if(!val('shipStreet')) errs.push('Shipping: Street');
  if(!val('shipCity')||!val('shipState')||!val('shipZip')) errs.push('Shipping: City/State/Zip');
  if(!val('payMethod')) errs.push('Payment: Method');
  const lines=getItems();
  lines.forEach((l,idx)=>{ if(!(l.sku&&l.qty&&l.sell)) errs.push(`Line ${idx+1}: SKU, Qty, and Sell are required`); });
  // Order-mode checks
  if (!ORDER_MODE) errs.push('Order Mode: select New format or Clone existing order');
  if (ORDER_MODE==='new' && !ORDER_TYPE) errs.push('New Order Type: select Hardware only or Hardware + Pro Services');
  if (ORDER_MODE === 'clone' && getCloneMissing().length) {
  errs.push('Clone: verify all checklist items');
}

  alert(errs.length?`❌ ${errs.length} issue(s):\n- ${errs.join('\n- ')}`:'✅ Looks good.');
}

/* ===== CSV for OM Email ===== */
function csvEscape(v){
  const s = String(v ?? '');
  if (/[",\r\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function buildCSV(){
  const items = getItems();

  const header = [
    'Document Type','Order Mode','Order Type','Clone Verified',
    'New Customer','WCP','Current Customer','3PL Restock',
    'Primary Rep','Secondary Rep','Referral Partner','Carrier Rep Name','Carrier Rep Email','CUC Rep',
    'Billing Company','Billing Contact','Billing Phone','Billing Email','Billing Street','Billing Suite','Billing City','Billing State','Billing Zip',
    'Payment Method','Payment Terms','Purchase Agreement','Tax Exempt',
    'Ship Company/Care Of','Ship Contact','Ship Phone','Ship Email','Ship Street','Ship Suite','Ship City','Ship State','Ship Zip','Residence','Ship Pay Method','Ship Speed','Short Ship','Requested Ship Date','Expected Ship Date','Internal Notes',
    'Line #','Item Description','Model / Part #','Color','SKU','Qty','Network','Carrier','Act Payout $','MSRP','Disc %','Sell Price','Condition','In Stock','Vendor','Quoted Cost','DLL/SPA / Deal Reg #','Hold/Reservation #','Delivery Lead Time','EOL Confirm',
    'Accessory SKU','Accessory Description','Accessory Qty (per unit)','Accessory Sell Price','Include Brick + Cable',
    'Services Included','Services Tier','Services Minutes (per device)','ServicesCost per device','Services Total Cost',
    'Insurance Plan','Insurance Deductible','Insurance Term','Insurance Sell Price','Insurance Cost Price',
    'SIM Card','Pairing Option','SIM Handling','Helix SIM Questionnaire',
    'License Vendor','License Duration','License Prorated Price','License Key / Simba Code','License Contact',
    'Carrier SPF Subsidy','Plan Code','Include Subsidy Verbiage','ABM','Knox (KME)','Knox Account #','Zero Touch','MDM Pro-Services','MDM Notes',
    'Lines Subtotal','Accessories Total','Services Total','Insurance Total','Tax','Grand Total'
  ].map(csvEscape).join(',');

  const cloneVerified = ORDER_MODE === 'clone' ? (getCloneMissing().length === 0 ? 'Yes' : 'No') : '';

  const commonFront = [
    [...document.querySelectorAll('input[name="doctype"]')].find(x=>x.checked)?.value||'QUOTE',
    ORDER_MODE||'',
    ORDER_MODE==='new' ? (ORDER_TYPE||'') : '',
    cloneVerified,
    bool('flagNewCustomer')?'Yes':'No',
    bool('flagWCP')?'Yes':'No',
    bool('flagCurrentCustomer')?'Yes':'No',
    bool('flag3PL')?'Yes':'No',
    val('rep1'), val('rep2'), val('refPartner'),
    val('carrierRepName'), val('carrierRepEmail'), val('cucRep'),
    val('billCompany'), val('billContact'), val('billPhone'), val('billEmail'),
    val('billStreet'), val('billSuite'), val('billCity'), val('billState'), val('billZip'),
    val('payMethod'), val('payTerms'), bool('hasAgreement')?'Yes':'No', bool('taxExempt')?'Yes':'No',
    val('shipCompany'), val('shipContact'), val('shipPhone'), val('shipEmail'),
    val('shipStreet'), val('shipSuite'), val('shipCity'), val('shipState'), val('shipZip'),
    bool('resShip')?'Yes':'No', val('shipPay'), val('shipSpeed'), val('shortShip'),
    val('reqShipDate'), val('expShipDate'), val('notes')
  ];

  const acc = [ val('accSku'), val('accDesc'), val('accQty'), val('accSell'), (document.getElementById('bcInclude').checked?'Yes':'No') ];
  const svc = [
    bool('svcEnabled')?'Yes':'No',
    val('svcTier') || '0',
    val('svcMinutes') || '0',
    val('svcSKU') || '—',
    val('svcCostPer') || '0.00',
    val('svcCostTotal') || '0.00'
  ];
  const ins = [ val('insPlan')||'None', val('insDed')||'—', val('insTerm')||'—', val('insSell')||'0.00', val('insCost')||'' ];
  const sim = [ val('simCard'), val('pairingOption'), val('simHandling'), val('simQuestionnaire') ];
  const lic = [ val('licVendor'), val('licDuration'), val('licProrated'), val('licKey'), val('licContact') ];
  const mdm = [
    bool('carrierSPF')?'Yes':'No', val('planCode'), bool('subsidyNote')?'Yes':'No',
    bool('mdmABM')?'Yes':'No', bool('mdmKnox')?'Yes':'No', val('knoxAccount'), bool('mdmZeroTouch')?'Yes':'No',
    bool('mdmPro')?'Yes':'No', val('mdmNotes')
  ];
  const t = computeTotals();
  const totals = [ fmt(t.linesSubtotal), fmt(t.accTotal), fmt(t.svcTotal), fmt(t.insTotal), fmt(t.tax), fmt(t.grand) ];

  const rows = items.length ? items.map((l,idx)=>{
    const linePart = [
      idx+1, l.desc||'', l.model||'', l.color||'', l.sku||'',
      l.qty||'', l.net||'', l.carrier||'', l.payout||'',
      l.msrp||'', l.disc||'', l.sell||'', l.cond||'',
      l.stock||'', l.vendor||'', l.cost||'', l.deal||'',
      l.hold||'', l.leadtime||'', l.eol||''
    ];
    return [...commonFront, ...linePart, ...acc, ...svc, ...ins, ...sim, ...lic, ...mdm, ...totals]
      .map(csvEscape).join(',');
  }) : [[...commonFront, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
         ...acc, ...svc, ...ins, ...sim, ...lic, ...mdm, ...totals].map(csvEscape).join(',')];

  return [header, ...rows].join('\n');
}
function refreshCSVPreview(){
  const csv = buildCSV();
  const ta = document.getElementById('csvPreview');
  if (ta) ta.value = csv;

  const toRaw   = document.getElementById('emailTo')?.value || 'service@connectuscorp.com';
  const subjRaw = document.getElementById('emailSubject')?.value || 'New Intake — CSV Summary';
  const body = 'Hello Order Management,%0D%0A%0D%0ASee attached CSV below (or included in the body if you use the Gmail button).%0D%0A%0D%0A— ConnectUS Intake';
  const href = `mailto:${encodeURIComponent(toRaw)}?subject=${encodeURIComponent(subjRaw)}&body=${body}`;
  const a = document.getElementById('mailtoHref'); if (a) a.href = href;
}
function copyCSVToClipboard(){ const s = document.getElementById('csvPreview')?.value || buildCSV(); navigator.clipboard.writeText(s); alert('CSV copied to clipboard.'); }
function downloadCSVFile(){
  const csv = document.getElementById('csvPreview')?.value || buildCSV();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = (val('billCompany')||'connectus-intake') + '-summary.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===== Generic helpers ===== */
function setVal(id,v){ const el=document.getElementById(id); if(el){ el.value=v; el.dispatchEvent(new Event('input',{bubbles:true})); } }
function selectByTextExact(id,text){
  const s=document.getElementById(id); if(!s) return;
  const t=String(text||'').trim();
  const opt=[...s.options].find(o=>o.text.trim().toLowerCase()===t.toLowerCase());
  if(opt) s.value = opt.value; s.dispatchEvent(new Event('change',{bubbles:true}));
}
function pick(...vals){ return vals.find(v=>v!==undefined && v!==null && String(v).trim()!=='') || ''; }
function setByPath(obj, path, value){
  const parts = path.split('.'); let cur=obj;
  parts.forEach((p,i)=>{ if(i===parts.length-1) cur[p]=value; else cur[p]=cur[p]||{}; cur=cur[p]; });
}

/* ===== Reps UI ===== */
function renderRepList(){
  const reps=getReps();
  const host=document.getElementById('repList');
  host.innerHTML='';
  reps.forEach((r,idx)=>{
    const card = el('div',{class:'card',style:'margin:8px 0'},[
      el('div',{html:`<strong>${r.name}</strong> — <span class="tiny">${r.email}</span><br><span class="tiny">slug:</span> ${r.slug || '—'}`}),
      el('div',{class:'row',style:'margin-top:8px'},[
        el('button',{class:'ghost',onclick:()=>loadRepIntoForm(idx)},[document.createTextNode('Edit')]),
        el('button',{class:'bad',onclick:()=>removeRep(idx)},[document.createTextNode('Remove')])
      ])
    ]);
    host.appendChild(card);
  });
  populateRepDropdowns();
}
function loadRepIntoForm(i){
  const r=getReps()[i]; if(!r) return;
  setVal('repNameInput', r.name||'');
  setVal('repEmailInput', r.email||'');
  setVal('repSlugInput', r.slug||'');
  document.getElementById('repTemplatePick').value='custom';
  setVal('repTemplateText', r.template||'');
}
function removeRep(i){
  const reps=getReps(); reps.splice(i,1); saveReps(reps); renderRepList(); populateRepDropdowns();
}
function populateRepDropdowns(){
  const reps=getReps();
  const ids=['rep1','rep2'];
  ids.forEach(id=>{
    const s=document.getElementById(id); if(!s) return;
    const cur = s.value;
    s.innerHTML = `<option value="">— Select —</option>` + reps.map(r=>`<option>${r.name}</option>`).join('');
    if(cur) selectByTextExact(id, cur);
  });
}
document.getElementById('btnSaveRep').addEventListener('click', ()=>{
  const name=val('repNameInput'); if(!name) return alert('Rep Name is required.');
  const email=val('repEmailInput'); const slug=val('repSlugInput');
  const template = val('repTemplateText') || (BASE_TEMPLATES[name]||'');
  const reps=getReps();
  const idx=reps.findIndex(r=>r.name.toLowerCase()===name.toLowerCase());
  const rec={name,email,slug,template};
  if(idx>=0) reps[idx]=rec; else reps.push(rec);
  saveReps(reps); renderRepList(); populateRepDropdowns(); alert('Rep saved.');
});
document.getElementById('btnResetRepForm').addEventListener('click', ()=>{
  ['repNameInput','repEmailInput','repSlugInput','repTemplateText'].forEach(id=>setVal(id,''));
  document.getElementById('repTemplatePick').value='custom';
});
document.getElementById('repTemplatePick').addEventListener('change', e=>{
  const pick=e.target.value;
  const t = pick==='custom' ? '' : (BASE_TEMPLATES[pick]||'');
  setVal('repTemplateText', t);
});

/* ===== Insurance / Tax toggle wiring ===== */
document.getElementById('insEnabled').addEventListener('change', toggleInsuranceFields);
document.getElementById('taxExempt').addEventListener('change', refreshTotals);

/* ===== Demo flow (updated for gate) ===== */
const DEMO_CUSTOMER_FULL = {
  company:"AmeriPro Health",
  billing:{contact:"John Smith",phone:"555-1111",email:"billing@acme.com",street:"1 Main St",suite:"Ste 100",city:"Philadelphia",state:"PA",zip:"19104"},
  shipping:{company:"Acme Warehouse",contact:"Melanie Porter",phone:"555-2222",email:"wh@acme.com",street:"500 Dock Rd",suite:"",city:"Philadelphia",state:"PA",zip:"19112"},
  payment:{method:"Net Terms",terms:"Net 30",taxExempt:true,agreement:false},
  shippingOptions:{pay:"CUC UPS and Invoice customer",speed:"Ground",shortShip:"No"},
  carrierRep:{name:"Verizon Rep",email:"vrep@vz.com"},
  rep:{primary:"Lucas Currin",secondary:"—"}
};
document.getElementById('btnDemoFlow').addEventListener('click', ()=>{
  // Gate: New + Pro
  const newMode = document.querySelector('input[name="order_mode"][value="new"]');
  if (newMode) { newMode.checked = true; ORDER_MODE='new'; }
  updateOrderModeUI();
  const proType = document.querySelector('input[name="order_type"][value="pro"]');
  if (proType) { proType.checked = true; ORDER_TYPE='pro'; }
  unlockIntakeTabs();

  document.getElementById('flagCurrentCustomer').checked=true;
  document.getElementById('flagWCP').checked=true;
  document.getElementById('flagNewCustomer').checked=false;

  setVal('wcpPaste', JSON.stringify(DEMO_CUSTOMER_FULL, null, 2));
  applyPastedCustomer('wcpPaste');

  addRow(QUOTE_REQUEST_MAP["QR-2025-00123"]);
  buildSummary();
  openDrawer('drawerEmail');
});

/* ===== Clear form (respects gate) ===== */
function clearAll(){
  // clear text inputs & textareas & selects
  document.querySelectorAll('input, textarea, select').forEach(el=>{
    if(el.type==='checkbox' || el.type==='radio'){ el.checked = false; }
    else el.value = '';
  });
  // reset selects where needed
  populateRepDropdowns();
  // clear items
  document.getElementById('itemsBody').innerHTML='';
  document.getElementById('totalsBox').style.display='none';
  document.getElementById('summary').textContent='';
  refreshCSVPreview();

  // Reset gate
  ORDER_MODE = null; ORDER_TYPE = null;
  updateOrderModeUI();
}

/* ===== On load ===== */
(function init(){
  renderRepList();
  populateRepDropdowns();
  toggleInsuranceFields(); // initial visibility
  refreshTotals();
  refreshCSVPreview();
  // Start with tabs locked until user picks a mode
  lockIntakeTabs();
})();

</script>

<script>
// === REQUIRED: all four verifications + existing SO# for CLONE ===

// Helper: check which clone requirements are missing
function getCloneMissing() {
  const missing = [];
  const so = (document.getElementById('soClone')?.value || '').trim();
  if (!so) missing.push('Existing Sales Order #');
  if (!document.getElementById('vCustomer')?.checked) missing.push('I have verified Customer information');
  if (!document.getElementById('vShipping')?.checked) missing.push('I have verified Shipping information');
  if (!document.getElementById('vItems')?.checked) missing.push('I have verified Items');
  if (!document.getElementById('vMDM')?.checked) missing.push('I have verified MDM');
  return missing;
}

// Enable Proceed only when ALL requirements met
function updateCloneProceedState() {
  const btn = document.getElementById('btnProceedClone');
  if (!btn) return;
  const missing = getCloneMissing();
  btn.disabled = missing.length > 0;
  btn.title = missing.length ? ('Required: ' + missing.join(' · ')) : '';
}

// Build the exact block needed in Summary & Email
function buildCloneVerificationBlock() {
  const val = (id) => (document.getElementById(id)?.value || '').trim();
  const yesNo = (id) => (document.getElementById(id)?.checked ? 'YES' : 'NO');
  const so = val('soClone');

  const lines = [
    'CLONE VERIFICATION',
    `Existing Sales Order #: ${so || '—'}`,
    `I have verified Customer information: ${yesNo('vCustomer')}`,
    `I have verified Shipping information: ${yesNo('vShipping')}`,
    `I have verified Items: ${yesNo('vItems')}`,
    `I have verified MDM: ${yesNo('vMDM')}`,
  ];

  // Optional notes (keep any you’ve already wired in)
  const maybeNotes = [
    ['vCustomerNote','Customer Notes'],
    ['vShippingNote','Shipping Notes'],
    ['vItemsNote','Items Notes'],
    ['vMDMNote','MDM Notes'],
  ].map(([id,label])=>{
    const v = val(id);
    return v ? `- ${label}: ${v}` : '';
  }).filter(Boolean);

  return lines.concat(maybeNotes, ['']).join('\n');
}

// Append to Summary (keeps existing below)
function recordCloneVerificationToSummary() {
  const summaryEl = document.getElementById('summary');
  if (!summaryEl) return;
  const block = buildCloneVerificationBlock();
  const existing = (summaryEl.textContent || '').trim();
  summaryEl.textContent = block + (existing ? ('\n' + existing) : '');
}

// Compose Gmail to OM with the required lines
function emailCloneVerificationToOM() {
  const to = (document.getElementById('emailTo')?.value || 'service@connectuscorp.com').trim();
  const so = (document.getElementById('soClone')?.value || '').trim();
  const company = (document.getElementById('billCompany')?.value || '').trim();

  const subject = `New Intake - Clone Verification — ${so || 'SO # TBD'}${company ? ` — ${company}` : ''}`;
  const header  = `Hello Order Management,\n\nPlease find the clone verification below.\n\n`;
  const bodyBlk = buildCloneVerificationBlock();
  const footer  = `\n— ConnectUS Intake`;
  const body    = `${header}${bodyBlk}${footer}`;

  if (typeof openGmailCompose === 'function') {
    openGmailCompose({ to, subject, body });
  } else {
    const url = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    openMailto(url);
  }
}

// Wire events for clone fields
['vCustomer','vShipping','vItems','vMDM','soClone'].forEach(id=>{
  const el = document.getElementById(id);
  if (!el) return;
  const evt = el.type === 'checkbox' ? 'change' : 'input';
  el.addEventListener(evt, updateCloneProceedState);
});

// Proceed handler: hard-stop if anything missing; else record + email
const proceedBtn = document.getElementById('btnProceedClone');
if (proceedBtn) {
  proceedBtn.addEventListener('click', ()=>{
    const missing = getCloneMissing();
    if (missing.length) {
      alert('Please complete the required items:\n• ' + missing.join('\n• '));
      updateCloneProceedState();
      return;
    }
    recordCloneVerificationToSummary();
    emailCloneVerificationToOM();
  });
}

// Initial state
document.addEventListener('DOMContentLoaded', updateCloneProceedState);
</script>


<script>
// === Show/Hide tabs & subtabs based on ORDER_TYPE ===
function updateTypeDependentUI() {
  const isNew = ORDER_MODE === 'new';
  const isPro = isNew && ORDER_TYPE === 'pro';
  const isHardwareOnly = isNew && ORDER_TYPE === 'hardware';

  // MDM tab + panel + step chip
  const mdmTabBtn = document.querySelector('.tab[data-tab="mdm"]');
  const mdmPanel  = document.querySelector('[data-panel="mdm"]');
  const mdmStep   = document.querySelector('#stepper .step[data-goto="mdm"]');

  if (isHardwareOnly) {
    // Hide MDM everywhere
    if (mdmTabBtn)  mdmTabBtn.style.display = 'none';
    if (mdmPanel)   mdmPanel.style.display  = 'none';
    if (mdmStep)    mdmStep.style.display   = 'none';

    // If user is currently on MDM, switch to Items
    const activeTab = document.querySelector('.tab.active');
    if (activeTab && activeTab.dataset.tab === 'mdm') {
      document.querySelector('.tab[data-tab="items"]')?.click();
    }
  } else {
    // Show MDM for Pro Services (and for non-new modes)
    if (mdmTabBtn)  mdmTabBtn.style.display = '';
    if (mdmStep)    mdmStep.style.display   = '';
    // Panel visibility is handled by tab clicks; default stays hidden until selected
  }

  // Items: Services mini-tab + panel
  const svcBtn   = document.querySelector('.subtab[data-sub="services"]');
  const svcPanel = document.querySelector('[data-subpanel="services"]');
  const svcEnabled = document.getElementById('svcEnabled');

  if (isHardwareOnly) {
    // Hide Services subtab & panel
    if (svcBtn)   svcBtn.style.display   = 'none';
    if (svcPanel) svcPanel.style.display = 'none';

    // If user had Services active, kick to Accessory
    const activeSub = document.querySelector('.subtab.active');
    if (activeSub && activeSub.dataset.sub === 'services') {
      document.querySelector('.subtab[data-sub="accessory"]')?.click();
    }

    // Disable/clear service costing so totals are clean
    if (svcEnabled && svcEnabled.checked) {
      svcEnabled.checked = false;
      recalcServices();
    }
  } else {
    // Pro Services → show Services subtab
    if (svcBtn)   svcBtn.style.display   = '';
    if (svcPanel) {
      // keep hidden until selected; do not auto-open here
    }
  }
  
  maybeShowEmailOMInline();
}

// Patch: when unlocking tabs (after picking mode/type), also apply type-dependent UI
const _origUnlock = unlockIntakeTabs;
unlockIntakeTabs = function() {
  _origUnlock();
  updateTypeDependentUI();
};

// Ensure mode/type switches re-evaluate the UI immediately
document.querySelectorAll('input[name="order_type"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    ORDER_TYPE = r.value;
    updateTypeDependentUI();
  });
});
document.querySelectorAll('input[name="order_mode"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    ORDER_MODE = r.value;
    updateTypeDependentUI();
  });
});


// Also apply after demo flow and clearAll
const _origDemo = document.getElementById('btnDemoFlow').onclick;
document.getElementById('btnDemoFlow').onclick = function(ev){
  if (typeof _origDemo === 'function') _origDemo.call(this, ev);
  updateTypeDependentUI();
};

const _origClearAll = clearAll;
clearAll = function(){
  _origClearAll();
  updateTypeDependentUI();
};

// Run once at init in case defaults are pre-selected
document.addEventListener('DOMContentLoaded', () => {
  updateOrderModeUI();       // NEW — makes sure type/clone row is shown correctly
  updateTypeDependentUI();   // then apply MDM/Services visibility
  if (typeof maybeShowEmailOMInline === 'function') {
    maybeShowEmailOMInline();
  }
});


</script>

<script>
// Heuristic: decide "Part" vs "Service" from SKU/desc keywords
function _classifyItemType(it){
  const sku  = String(it.sku || it.ordertimeSku || it.item || '').toUpperCase();
  const desc = String(it.desc || '').toUpperCase();
  const hay  = sku + ' ' + desc;

  // Tweak this list to your needs
  if (/(PROSERV|SERVICE|MDM|ABM|KNOX|ZERO\s*TOUCH|PAIR(ING)?|ESIM|SIM\s*PAIR|LICENSE|SUBSCRIPTION|PLAN|SETUP|CONFIG|ACTIVATION)/.test(hay)) {
    return 'Service';
  }
  return 'Part';
}
</script>


<script>
// ================== Sales Order CSV Export (Header + Line) ==================
// Columns (from your template files)
const SO_HEADER_COLUMNS = [
  'Id','DocNo','Customer','Customer PO','Primary Sales Rep','Secondary Sales Rep','Carrier Rep Name','Carrier Rep Email','Tran Type','Ship To','Is New','Discount','Cust. Req. Ship By Date','Short Ship','Ship Amount', 'Ship Address Street','Shipped Date','Bill Address City','Bill Address Contact',
  'Bill Address Email','Bill Address Name/Company','Bill Address Phone',
  'Bill Address Street','Bill Address Zip/Postal code','Ship Address City',
  'Ship Address Contact','Ship Address Country','Ship Address Email',
  'Ship Address Name/Company','Ship Address Phone','Ship Address State/Prov./Reg.',
  'Ship Address Zip/Postal code','Ship Method'
];
const SO_LINE_COLUMNS = [
  'No.','Customer','Item','ItemType','Line Instructions','Quantity','Price','Tran Type'
];

// Reuse your existing csvEscape(); provide lightweight helpers
function _toCSV(columns, rows){
  const head = columns.map(csvEscape).join(',');
  const body = rows.map(r => columns.map(c => csvEscape(r[c])).join(',')).join('\n');
  return head + (rows.length ? '\n' + body : '');
}
function _downloadBlob(filename, text, mime='text/csv'){
  const blob = new Blob([text], { type: mime + ';charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// ---------- FIELD MAPPING (HEADER) ----------
// Spec you gave:
// - Customer  -> "Customer Name" (your UI uses Billing "Company Name" => #billCompany)
// - Tran Type -> hardcoded "Sale order"
// - Ship To   -> hardcoded "Primary"
// - Is New    -> hardcoded "TRUE"
// - Ship Amount -> Grand Total (from computeTotals().grand)
// Other columns left blank or best-effort (DocNo/Customer PO)
function _textById(id){
  const el = document.getElementById(id);
  if (!el) return '';
  return (('value' in el ? el.value : el.textContent) || '').trim();
}
function _moneyNumToString(n){
  // stringify numeric as plain text for CSV (no $)
  const num = Number.isFinite(n) ? n : 0;
  return String(num);
}
function _joinStreet(streetId, suiteId){
  const s  = _textById(streetId);
  const su = _textById(suiteId);
  return [s, su].filter(Boolean).join(' ').trim();
}

function collectHeaderRows(){
  const totals = (typeof computeTotals === 'function') ? computeTotals() : { grand: 0 };

  const row = {
    // === existing mappings ===
    'Id':          '',
    'DocNo':       '',
    'Customer':    _textById('billCompany'),
    'Customer PO': _textById('customerPO') || '',
    'Primary Sales Rep':   _textById('rep1'),
    'Secondary Sales Rep': _textById('rep2'),
    'Carrier Rep Name':    _textById('carrierRepName'),
    'Carrier Rep Email':   _textById('carrierRepEmail'),
    'Tran Type':   'Sale order',
    'Ship To':     _textById('shipContact'),
    'Is New':      'TRUE',
    'Discount':    '0',
    'Cust. Req. Ship By Date': _textById('reqShipDate'),
    'Short Ship': (() => {
      const v = _textById('shortShip').toLowerCase();
      if (v === 'yes') return '1';
      if (v === 'no')  return '0';
      return '';
    })(),
    'Ship Amount': String(Number.isFinite(totals.grand) ? totals.grand : 0),

    // === NEW fields (from your request) ===
    // Shipping address
    'Ship Address Street': _joinStreet('shipStreet','shipSuite'),
    'Shipped Date':        _textById('expShipDate'),         // if you prefer, leave '' or map differently
    // Billing address
    'Bill Address City':         _textById('billCity'),
    'Bill Address Contact':      _textById('billContact'),
    'Bill Address Email':        _textById('billEmail'),
    'Bill Address Name/Company': _textById('billCompany'),
    'Bill Address Phone':        _textById('billPhone'),
    'Bill Address Street':       _joinStreet('billStreet','billSuite'),
    'Bill Address Zip/Postal code': _textById('billZip'),
    // Ship-to details
    'Ship Address City':            _textById('shipCity'),
    'Ship Address Contact':         _textById('shipContact'),
    'Ship Address Country':         '',                        // set 'USA' if you want a default
    'Ship Address Email':           _textById('shipEmail'),
    'Ship Address Name/Company':    _textById('shipCompany'),
    'Ship Address Phone':           _textById('shipPhone'),
    'Ship Address State/Prov./Reg.': _textById('shipState'),
    'Ship Address Zip/Postal code':  _textById('shipZip'),
    // Ship Method (using your “Shipping Speed” picker)
    'Ship Method': _textById('shipSpeed') || ''               // change to 'shipPay' if Ops wants payment method
  };

  return [row];

}
function collectLineRows(){
  const items = (typeof getItems === 'function') ? getItems() : [];
  const customer = _textById('billCompany');

  return items
    .filter(it => it && Object.values(it).some(v => String(v||'').trim() !== ''))
    .map(it => ({
      'No.':               '',                        // leave blank
      'Customer':          customer,
      'Item':              it.sku || it.ordertimeSku || it.item || '',
      'ItemType':          _classifyItemType(it),      // Part or Service
      'Line Instructions': it.instructions || '',                         // placeholder until you add a per-line field
      'Quantity':          it.qty || '1',
      'Price':             it.sell || '',              // Sell Price
      'Tran Type':         '7'                         // hardcoded
    }));
}

// ---------- Button handlers (used by your drawer) ----------
function downloadSaleOrderHeaderCSV(){
  const rows = collectHeaderRows();
  const csv  = _toCSV(SO_HEADER_COLUMNS, rows);
  _downloadBlob('Sales_Order_Header.csv', csv);
}
function downloadSaleOrderLineCSV(){
  const rows = collectLineRows();
  const csv  = _toCSV(SO_LINE_COLUMNS, rows);
  _downloadBlob('Sales_Order_Line.csv', csv);
}
</script>

</body>

</html>
